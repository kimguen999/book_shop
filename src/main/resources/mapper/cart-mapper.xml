<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- 해당 파일에 모든 쿼리문을 작성 -->
<!-- namespace에는 xml파일과 연결할 Mapper interface 파일명을 패키지를 포함하여 적어주세요 -->
<mapper namespace="com.green.book_shop_t.cart.mapper.CartMapper">

    <resultMap id="cart" type="com.green.book_shop_t.cart.dto.CartDTO">
        <id column="CART_NUM"         property="cartNum"/>
        <result column="CART_CNT"     property="cartCnt"/>
        <result column="CART_DATE"    property="cartDate"/>
        <result column="BOOK_NUM"     property="bookNum"/>
        <result column="MEM_EMAIL"    property="memEmail"/>

<!--    <association property="" resultMap=""></association>
        1 : 1 관계는 associaation-->
        <association property="bookList" resultMap="com.green.book_shop_t.book.mapper.BookMapper.book"/>
        <association property="member" resultMap="com.green.book_shop_t.member.mapper.MemberMapper.member"/>
        <!-- 1 : N관계는 collection,
        property는 CartDTO에 연결된 DTO의 변수명, resultMap은 땡겨올 클래스의 xml namespace.id -->
    </resultMap>


    <!--장바구니 버튼 클릭시 해당 상품 장바구니로 삽입 쿼리-->
    <insert id="insertCart">
        INSERT INTO SHOP_CART (
            CART_CNT
            , CART_DATE
            , BOOK_NUM
            , MEM_EMAIL
        ) VALUES (
            #{cartCnt}
            , NOW()
            , #{bookNum}
            , #{memEmail}
        )
    </insert>



    <!--장바구니 조회 쿼리-->
    <select id="cartList" resultMap="cart">
        SELECT
            CART_NUM
            , CART_CNT
            , CART_DATE
            , C.BOOK_NUM
            , C.MEM_EMAIL
            , B.BOOK_TITLE
            , B.BOOK_PRICE
            , UPLOAD_FILE_NAME
        FROM
            SHOP_CART C
                INNER JOIN SHOP_BOOK B
                    ON C.BOOK_NUM = B.BOOK_NUM
                INNER JOIN SHOP_MEMBER M
                    ON C.MEM_EMAIL = M.MEM_EMAIL
                INNER JOIN BOOK_IMG I
                    ON C.BOOK_NUM = I.BOOK_NUM
        WHERE I.IS_MAIN = 'Y'
            AND C.MEM_EMAIL = #{memEmail}
        ORDER BY CART_NUM DESC

    </select>


    <!--장바구니에 상품 중복인지 판단 쿼리, 조회가 되냐 안되냐가 중요-->
    <select id="isDuplicateBook" resultType="string">
        SELECT
            MEM_EMAIL
            <!--단순히 수량에 null이 필요해서
            null을 쓸수있는 string인 MEM_EMAIL 사용한거-->
        FROM
            SHOP_CART

        WHERE BOOK_NUM = #{bookNum}
            AND MEM_EMAIL = #{memEmail}

    </select>

    <!--장바구니 업데이트 쿼리, 수량.날짜 변경-->
    <update id="updateCartBook">
        UPDATE
            SHOP_CART
        SET
            CART_CNT = CART_CNT + #{cartCnt}
            , CART_DATE = SYSDATE()
        WHERE
            BOOK_NUM = #{bookNum}
            AND MEM_EMAIL = #{memEmail}
    </update>

    <!--장바구니 삭제 클릭 시 목록 1줄 삭제 쿼리-->
    <delete id="deleteCart">
        DELETE FROM
            SHOP_CART
        WHERE
            CART_NUM = #{cartNum}
    </delete>

</mapper>







